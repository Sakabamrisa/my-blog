---
---

<canvas 
  id="gol-canvas" 
  class="fixed inset-0 -z-10 pointer-events-none"
  transition:persist="gol-background"
></canvas>

<style>
  #gol-canvas {
    opacity: 0.04;
  }
  
  @media (prefers-reduced-motion: reduce) {
    #gol-canvas {
      display: none;
    }
  }
</style>

<script>
  function initGameOfLife() {
    var canvas = document.getElementById('gol-canvas');
    if (!canvas) return;
    
    var ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    var resolution = 16;
    var cols = 0;
    var rows = 0;
    var grid = [];
    var running = false;
    
    function buildGrid() {
      var g = [];
      for (var c = 0; c < cols; c++) {
        g[c] = [];
        for (var r = 0; r < rows; r++) {
          g[c][r] = Math.floor(Math.random() * 2);
        }
      }
      return g;
    }
    
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      cols = Math.floor(canvas.width / resolution);
      rows = Math.floor(canvas.height / resolution);
      grid = buildGrid();
    }
    
    function countNeighbors(g, col, row) {
      var count = 0;
      for (var i = -1; i <= 1; i++) {
        for (var j = -1; j <= 1; j++) {
          if (i === 0 && j === 0) continue;
          var x = col + i;
          var y = row + j;
          if (x >= 0 && x < cols && y >= 0 && y < rows) {
            count += g[x][y];
          }
        }
      }
      return count;
    }
    
    function nextGen() {
      var newGrid = [];
      for (var c = 0; c < cols; c++) {
        newGrid[c] = [];
        for (var r = 0; r < rows; r++) {
          var cell = grid[c][r];
          var neighbors = countNeighbors(grid, c, r);
          if (cell === 1 && (neighbors < 2 || neighbors > 3)) {
            newGrid[c][r] = 0;
          } else if (cell === 0 && neighbors === 3) {
            newGrid[c][r] = 1;
          } else {
            newGrid[c][r] = cell;
          }
        }
      }
      grid = newGrid;
    }
    
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      ctx.fillStyle = isDark ? '#d4af37' : '#006cac';
      
      for (var c = 0; c < cols; c++) {
        for (var r = 0; r < rows; r++) {
          if (grid[c][r]) {
            ctx.fillRect(c * resolution, r * resolution, resolution - 2, resolution - 2);
          }
        }
      }
    }
    
    function update() {
      if (!running) return;
      nextGen();
      render();
      setTimeout(function() {
        requestAnimationFrame(update);
      }, 150);
    }
    
    function start() {
      if (running) return;
      running = true;
      resize();
      update();
    }
    
    window.golStart = start;
    window.golResize = resize;
    
    start();
  }
  
  window.addEventListener('resize', function() {
    if (window.golResize) window.golResize();
  });
  
  document.addEventListener('astro:page-load', function() {
    if (!window.golInitialized) {
      window.golInitialized = true;
      initGameOfLife();
    } else if (window.golStart) {
      window.golStart();
    }
  });
  
  if (!window.golInitialized) {
    window.golInitialized = true;
    initGameOfLife();
  }
</script>
