---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import getPostsByGroupCondition from "@/utils/getPostsByGroupCondition";
import { SITE } from "@/config";

if (!SITE.showArchives) {
  return Astro.redirect("/404");
}

const posts = await getCollection("blog", ({ data }) => !data.draft);

const months = [
  "一月", "二月", "三月", "四月", "五月", "六月",
  "七月", "八月", "九月", "十月", "十一月", "十二月",
];
---

<Layout title={`归档 | ${SITE.title}`}>
  <Header />
  
  <style>
    /* ========== 页面级进入动画 ========== */
    .fade-in-up {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========== 科技感时间轴动画 ========== */
    .draw-line {
      transform-origin: top;
      transform: scaleY(0);
      animation: drawLine 1.2s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      animation-delay: 0.1s;
    }
    @keyframes drawLine {
      to { transform: scaleY(1); }
    }

    .timeline-item {
      opacity: 0;
      transform: translateX(-15px);
      animation: slideInRight 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }
    @keyframes slideInRight {
      to { opacity: 1; transform: translateX(0); }
    }

    /* ========== 悬浮交互反馈 ========== */
    .glow-bar {
      transition: all 0.3s ease;
    }
    .group-hover-title:hover .glow-bar {
      box-shadow: 0 0 15px rgba(var(--color-accent-rgb), 0.6);
      width: 0.375rem;
    }
    
    .hover-glow:hover .timeline-dot {
      box-shadow: 0 0 15px rgba(var(--color-accent-rgb), 0.8);
      background-color: rgba(var(--color-accent-rgb), 1);
      transform: scale(1.3);
    }
  </style>
  
  <main id="main-content" class="app-layout py-12 min-h-[70vh] max-w-3xl mx-auto px-4 sm:px-8">
    
    <!-- 顶部标题区域 (无点击，仅悬浮反馈) -->
    <section class="mb-12 fade-in-up group group-hover-title cursor-default">
      <div class="flex items-center gap-4 mb-3">
        <div class="glow-bar w-1 h-10 bg-accent rounded-full transition-transform duration-300"></div>
        <h1 class="text-4xl font-bold tracking-wide transition-transform duration-300 group-hover-title:translate-x-2">归档</h1>
      </div>
      <div class="pl-6 ml-1 border-l-2 border-accent/20">
        <p class="text-lg opacity-70 font-medium tracking-wide">
          在这里，可以按年份和月份回顾所有的足迹。
        </p>
      </div>
    </section>
    
    <!-- 树状时间轴区域 -->
    <section class="relative">
      
      <!-- 主轴线 -->
      <div class="absolute left-[3px] sm:left-[11px] top-2 bottom-0 w-[2px] bg-gradient-to-b from-accent via-accent/30 to-transparent draw-line z-0"></div>
      
      <div class="space-y-12">
        {Object.entries(
          getPostsByGroupCondition(posts, post => post.data.pubDatetime.getFullYear())
        )
          .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
          .map(([year, yearGroup], yearIndex) => (
            
            /* 年份作为主节点 */
            <div class="relative pl-8 sm:pl-10 group hover-glow timeline-item" style={`animation-delay: ${0.2 + yearIndex * 0.15}s`}>
              
              <!-- 年份发光圆点 -->
              <div class="absolute left-[-2px] sm:left-1 top-2.5 w-3 h-3 rounded-full border-2 border-accent bg-skin-base z-10 timeline-dot transition-all duration-300">
                <div class="absolute inset-0 bg-accent/40 rounded-full animate-ping" style="animation-duration: 2s;"></div>
              </div>
              
              <!-- 年份标题 -->
              <div class="flex items-center gap-3 mb-6 transition-transform duration-300 group-hover:translate-x-1">
                <span class="text-3xl font-bold text-accent tracking-wider">{year}</span>
                <span class="text-sm font-mono opacity-50 px-2 py-0.5 rounded border border-border/50 bg-skin-card">{yearGroup.length} 篇</span>
              </div>
              
              <!-- 月份子节点列表 -->
              <div class="space-y-8 pl-1">
                {Object.entries(
                  getPostsByGroupCondition(yearGroup, post => post.data.pubDatetime.getMonth() + 1)
                )
                  .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
                  .map(([month, monthGroup], monthIndex) => (
                    
                    <div class="timeline-item" style={`animation-delay: ${0.4 + yearIndex * 0.1 + monthIndex * 0.1}s`}>
                      <div class="pl-5 border-l-2 border-border/50 relative before:absolute before:w-1.5 before:h-1.5 before:bg-accent/70 before:rounded-full before:-left-[4px] before:top-2 hover:border-accent/50 transition-colors duration-300">
                        
                        <div class="flex flex-wrap items-baseline gap-2 mb-4">
                          <span class="font-semibold text-xl opacity-90">{months[Number(month) - 1]}</span>
                          <span class="text-xs opacity-40">{monthGroup.length} 篇</span>
                        </div>
                        
                        <ul class="space-y-4">
                          {monthGroup
                            .sort((a, b) => new Date(b.data.pubDatetime).getTime() - new Date(a.data.pubDatetime).getTime())
                            .map((data, i) => (
                              <!-- 文章卡片级联弹出 -->
                              <li class="timeline-item transition-transform duration-300 hover:translate-x-1" style={`animation-delay: ${0.5 + yearIndex * 0.1 + monthIndex * 0.1 + i * 0.05}s`}>
                                <Card {...data} />
                              </li>
                            ))}
                        </ul>
                        
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          ))}
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const animItems = document.querySelectorAll('.timeline-item, .fade-in-up, .draw-line');
    animItems.forEach(item => {
      const el = item as HTMLElement;
      el.style.animation = 'none';
      el.offsetHeight; 
      el.style.animation = '';
    });
  });
</script>