---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout title="å·´å·´åšå¼ˆ">
  <Header />
  <style>
    .game-container {
      background: var(--background);
      border-color: var(--border);
    }
    
    .game-title {
      color: var(--accent);
    }
    
    .game-subtitle {
      color: var(--accent);
    }
    
    .gold-gradient {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 50%, var(--accent) 100%);
    }
    
    .gold-border {
      border-color: var(--accent);
    }
    
    .gold-glow {
      box-shadow: 0 0 20px color-mix(in srgb, var(--accent) 15%, transparent);
    }
    
    .gold-text {
      color: var(--accent);
    }
    
    .physics-spring {
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes idle-wobble {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(0.5deg); }
      75% { transform: rotate(-0.5deg); }
    }
    .wobble {
      animation: idle-wobble 4s ease-in-out infinite;
    }

    .candy-item {
      transition: all 0.5s ease;
      animation: drop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes drop-in {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .game-btn {
      background: var(--muted);
      color: var(--accent);
      border-color: var(--accent);
    }
    .game-btn:hover:not(:disabled) {
      background: var(--accent);
      color: var(--background);
    }
    .game-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .pile-container {
      background: var(--muted);
      border-color: var(--accent);
    }
    
    .rules-box {
      background: var(--muted);
      border-color: var(--border);
    }
  </style>

  <main class="app-layout py-12 min-h-screen">
    <section class="mb-10 text-center">
      <h1 class="text-4xl font-bold mb-2 game-title tracking-wider">å·´å·´åšå¼ˆ</h1>
      <p class="game-subtitle opacity-60 text-sm">Nim Game</p>
    </section>

    <div class="max-w-2xl mx-auto px-4">
      <div class="game-container border rounded-2xl p-8 mb-8 gold-glow relative overflow-hidden">
        
        <div class="relative w-full h-56 mb-12 mt-4 flex justify-center">
          <div class="relative w-64 h-full wobble" id="scale-wrapper">
            
            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3 h-40 gold-gradient rounded-t-full shadow-lg z-0"></div>
            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-20 h-4 gold-gradient rounded-t-lg z-0"></div>
            <div class="absolute top-16 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full gold-gradient border-2 z-20 shadow-md" style="border-color: var(--background);"></div>

            <div id="scale-beam" class="absolute top-[70px] left-0 w-full h-2 gold-gradient rounded-full physics-spring origin-center z-10">
              
              <div class="absolute -top-1 left-0 w-2 h-4 rounded-full" style="background: var(--accent);">
                <div id="left-pan-wrapper" class="absolute top-2 left-1/2 -translate-x-1/2 w-20 h-24 physics-spring origin-top flex flex-col items-center">
                  <div class="w-full h-16 relative">
                    <div class="absolute top-0 left-1/2 w-0.5 h-full opacity-60 -rotate-15 origin-top-left" style="background: var(--accent);"></div>
                    <div class="absolute top-0 right-1/2 w-0.5 h-full opacity-60 rotate-15 origin-top-right" style="background: var(--accent);"></div>
                  </div>
                  <div class="w-24 h-4 gold-gradient rounded-b-full shadow-lg relative flex justify-center items-end pb-1 gap-1 flex-wrap-reverse" id="left-pan">
                  </div>
                  <div class="mt-2 gold-text font-bold text-lg" id="player-candies">0</div>
                  <div class="text-xs opacity-60">ä½ </div>
                </div>
              </div>

              <div class="absolute -top-1 right-0 w-2 h-4 rounded-full" style="background: var(--accent);">
                <div id="right-pan-wrapper" class="absolute top-2 left-1/2 -translate-x-1/2 w-20 h-24 physics-spring origin-top flex flex-col items-center">
                  <div class="w-full h-16 relative">
                    <div class="absolute top-0 left-1/2 w-0.5 h-full opacity-60 -rotate-15 origin-top-left" style="background: var(--accent);"></div>
                    <div class="absolute top-0 right-1/2 w-0.5 h-full opacity-60 rotate-15 origin-top-right" style="background: var(--accent);"></div>
                  </div>
                  <div class="w-24 h-4 gold-gradient rounded-b-full shadow-lg relative flex justify-center items-end pb-1 gap-1 flex-wrap-reverse" id="right-pan">
                  </div>
                  <div class="mt-2 gold-text font-bold text-lg" id="ai-candies">0</div>
                  <div class="text-xs opacity-60">å·´å·´</div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="text-center mb-8 p-4 pile-container rounded-xl border" style="border-color: color-mix(in srgb, var(--accent) 20%, transparent);">
          <div class="text-3xl mb-3 flex justify-center flex-wrap gap-2 min-h-[40px]" id="pile"></div>
          <p class="gold-text font-medium tracking-widest text-sm" id="pile-count">å‰©ä½™ç³–æœ: 10 é¢—</p>
        </div>

        <div id="game-status" class="text-center mb-6 h-12 flex flex-col justify-center">
          <p class="text-lg font-medium">è½®åˆ°ä½ äº†ï¼</p>
          <p class="opacity-60 text-sm">æ¯æ¬¡å¯ä»¥æ‹¿ 1-3 é¢—ç³–æœ</p>
        </div>

        <div id="controls" class="flex justify-center gap-4 mb-2">
          <button id="take-1" class="game-btn px-6 py-3 border font-bold rounded-xl transition-all duration-300">æ‹¿ 1 é¢—</button>
          <button id="take-2" class="game-btn px-6 py-3 border font-bold rounded-xl transition-all duration-300">æ‹¿ 2 é¢—</button>
          <button id="take-3" class="game-btn px-6 py-3 border font-bold rounded-xl transition-all duration-300">æ‹¿ 3 é¢—</button>
        </div>

        <div id="restart-container" class="text-center hidden mb-2">
          <button id="restart" class="px-8 py-3 gold-gradient font-bold rounded-xl transition-all duration-300 transform hover:scale-105" style="color: var(--background);">å†æ¥ä¸€å±€</button>
        </div>
      </div>

      <div class="rules-box p-5 rounded-xl opacity-80 text-sm border">
        <p class="gold-text font-bold mb-2 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
          æ¸¸æˆè§„åˆ™
        </p>
        <ul class="list-disc list-inside space-y-1.5 opacity-70 ml-1">
          <li>åŒæ–¹è½®æµä»ç³–æœå †ä¸­æ‹¿å–ç³–æœ</li>
          <li>æ¯æ¬¡åªèƒ½æ‹¿å– <strong class="gold-text">1 åˆ° 3 é¢—</strong></li>
          <li>æ‹¿åˆ° <strong class="gold-text">æœ€åä¸€é¢—ç³–æœ</strong> çš„äººè·èƒœ</li>
        </ul>
      </div>
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline>
(function() {
  let pile = 10;
  let playerCandies = 0;
  let aiCandies = 0;
  let gameOver = false;
  let playerTurn = true;

  const pileDisplay = document.getElementById('pile');
  const pileCountDisplay = document.getElementById('pile-count');
  const playerCandiesDisplay = document.getElementById('player-candies');
  const aiCandiesDisplay = document.getElementById('ai-candies');
  
  const scaleBeam = document.getElementById('scale-beam');
  const leftPanWrapper = document.getElementById('left-pan-wrapper');
  const rightPanWrapper = document.getElementById('right-pan-wrapper');
  const leftPan = document.getElementById('left-pan');
  const rightPan = document.getElementById('right-pan');

  const gameStatus = document.getElementById('game-status');
  const controls = document.getElementById('controls');
  const restartContainer = document.getElementById('restart-container');
  const take1Btn = document.getElementById('take-1');
  const take2Btn = document.getElementById('take-2');
  const take3Btn = document.getElementById('take-3');
  const restartBtn = document.getElementById('restart');

  function createCandyHTML() {
    return `<span class="candy-item text-lg leading-none -mt-1 drop-shadow-md">ğŸ¬</span>`;
  }

  function updateDisplay() {
    pileDisplay.innerHTML = Array(pile).fill(createCandyHTML()).join('');
    pileCountDisplay.textContent = `å‰©ä½™ç³–æœ: ${pile} é¢—`;
    
    playerCandiesDisplay.textContent = playerCandies;
    aiCandiesDisplay.textContent = aiCandies;

    leftPan.innerHTML = Array(playerCandies).fill(createCandyHTML()).join('');
    rightPan.innerHTML = Array(aiCandies).fill(createCandyHTML()).join('');
    
    const weightDifference = aiCandies - playerCandies;
    let angle = weightDifference * 4;
    
    if (angle > 30) angle = 30;
    if (angle < -30) angle = -30;

    scaleBeam.style.transform = `rotate(${angle}deg)`;
    
    leftPanWrapper.style.transform = `rotate(${-angle}deg)`;
    rightPanWrapper.style.transform = `rotate(${-angle}deg)`;
  }

  function disableButtons() {
    [take1Btn, take2Btn, take3Btn].forEach(btn => {
      btn.disabled = true;
    });
  }

  function enableButtons() {
    [take1Btn, take2Btn, take3Btn].forEach(btn => {
      const takeAmount = parseInt(btn.id.replace('take-', ''));
      btn.disabled = pile < takeAmount;
    });
  }

  function playerMove(n) {
    if (gameOver || !playerTurn || pile < n) return;
    
    pile -= n;
    playerCandies += n;
    updateDisplay();
    
    if (pile <= 0) {
      endGame(true);
      return;
    }
    
    playerTurn = false;
    disableButtons();
    gameStatus.innerHTML = '<p class="text-lg font-medium gold-text animate-pulse">å·´å·´æ­£åœ¨æ€è€ƒ...</p>';
    
    setTimeout(aiMove, 1200);
  }

  function aiMove() {
    let take;
    const remainder = pile % 4;
    
    if (remainder === 0) {
      take = Math.floor(Math.random() * 3) + 1;
    } else {
      take = remainder;
    }
    
    take = Math.min(take, pile);
    pile -= take;
    aiCandies += take;
    
    updateDisplay();
    
    if (pile <= 0) {
      endGame(false);
      return;
    }
    
    playerTurn = true;
    enableButtons();
    gameStatus.innerHTML = `<p class="text-lg font-medium">å·´å·´æ‹¿äº† <span class="gold-text font-bold">${take}</span> é¢—</p><p class="opacity-60 text-sm">è½®åˆ°ä½ äº†ï¼</p>`;
  }

  function endGame(playerWins) {
    gameOver = true;
    disableButtons();
    controls.classList.add('hidden');
    restartContainer.classList.remove('hidden');
    
    if (playerWins) {
      gameStatus.innerHTML = '<p class="text-2xl font-bold gold-text">ğŸ‰ æ­å–œï¼Œä½ èµ¢äº†ï¼</p>';
    } else {
      gameStatus.innerHTML = '<p class="text-2xl font-bold opacity-60">ğŸ˜ˆ å·´å·´èµ¢äº†ï¼Œå†è¯•ä¸€æ¬¡ï¼Ÿ</p>';
    }
  }

  function resetGame() {
    pile = 10;
    playerCandies = 0;
    aiCandies = 0;
    gameOver = false;
    playerTurn = true;
    updateDisplay();
    enableButtons();
    controls.classList.remove('hidden');
    restartContainer.classList.add('hidden');
    gameStatus.innerHTML = '<p class="text-lg font-medium">è½®åˆ°ä½ äº†ï¼</p><p class="opacity-60 text-sm">æ¯æ¬¡å¯ä»¥æ‹¿ 1-3 é¢—ç³–æœ</p>';
  }

  take1Btn.addEventListener('click', () => playerMove(1));
  take2Btn.addEventListener('click', () => playerMove(2));
  take3Btn.addEventListener('click', () => playerMove(3));
  restartBtn.addEventListener('click', resetGame);

  updateDisplay();
  enableButtons();
})();
</script>
